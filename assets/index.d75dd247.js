var he=Object.defineProperty,ye=Object.defineProperties;var fe=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var X=(s,p,d)=>p in s?he(s,p,{enumerable:!0,configurable:!0,writable:!0,value:d}):s[p]=d,o=(s,p)=>{for(var d in p||(p={}))Z.call(p,d)&&X(s,d,p[d]);if(L)for(var d of L(p))ee.call(p,d)&&X(s,d,p[d]);return s},c=(s,p)=>ye(s,fe(p));var te=(s,p)=>{var d={};for(var h in s)Z.call(s,h)&&p.indexOf(h)<0&&(d[h]=s[h]);if(s!=null&&L)for(var h of L(s))p.indexOf(h)<0&&ee.call(s,h)&&(d[h]=s[h]);return d};import{d as ge}from"./Create.c02587ea.js";import{d as xe,u as be,a as we,b as ve,T as _e,D as ke,e as Ne,g as Se,h as De,r as $e}from"./index.f08fdfc8.js";import{c as Y,i as G,r as J,G as Ce,u as ze,U as pe,a as ae,R as l,aI as Te,j as u,p as O,a6 as b,b as t,ae as Fe,a7 as q,a8 as ce,J as re,K as Re,L as Ae,M as oe,N as ie,a4 as Ue,Y as Ee,aJ as je,A as Le,an as Oe,T as Ie,H as Me}from"./index.5e723353.js";import{A as Be,P as Pe}from"./index.4e8fd2e6.js";import{R as ne,S as se}from"./Render.f1e72879.js";import{N as le}from"./index.4c9ba486.js";import{d as He}from"./Reply.9d43ef53.js";import"./TextField.b78d12af.js";import"./useFormControl.ee9cff0d.js";import"./SwitchBase.10d93e74.js";var V={},We=G.exports;Object.defineProperty(V,"__esModule",{value:!0});var de=V.default=void 0,qe=We(Y),Ye=J,Ge=(0,qe.default)((0,Ye.jsx)("path",{d:"m21.41 11.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"}),"LocalOffer");de=V.default=Ge;var K={},Je=G.exports;Object.defineProperty(K,"__esModule",{value:!0});var ue=K.default=void 0,Ve=Je(Y),Ke=J,Qe=(0,Ve.default)((0,Ke.jsx)("path",{d:"M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"}),"ThumbUpAlt");ue=K.default=Qe;var Q={},Xe=G.exports;Object.defineProperty(Q,"__esModule",{value:!0});var me=Q.default=void 0,Ze=Xe(Y),et=J,tt=(0,Ze.default)((0,et.jsx)("path",{d:"M21 8h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2c0-1.1-.9-2-2-2zm0 4-3 7H9V9l4.34-4.34L12.23 10H21v2zM1 9h4v12H1z"}),"ThumbUpAltOutlined");me=Q.default=tt;const rt=Ce(()=>({icon:{minWidth:"auto"}})),ot=({post:s,item:p,topicAuthor:d,onReply:h})=>{const x=rt(),{hash:w}=ze(),n=pe("down","sm"),{isAuthed:v,accesstoken:C,uname:z}=ae(e=>e.auth),[_,T]=l.useState({ups:p.ups.length,isUped:p.is_uped}),{author:{loginname:y,avatar_url:F},id:m,create_at:I,content:M}=p,[f,g]=l.useState(null),[B,R]=l.useState(""),k=l.useRef(!1),[N,A]=l.useState({open:!1,url:""}),[P,S]=l.useState({open:!1,status:"success",message:""}),H=async()=>{if(!v){S(i=>c(o({},i),{open:!0,status:"success",message:"\u767B\u5F55\u540E\u624D\u80FD \u{1F44D} \u54DF~"}));return}if(y===z){S(i=>c(o({},i),{open:!0,status:"success",message:"\u4E0D\u80FD \u{1F44D} \u81EA\u5DF1\u7684\u54DF~"}));return}k.current=!1;const{success:e,err_msg:a}=await be({reply_id:m,accesstoken:C});k.current||(e?T(i=>{const{ups:D,isUped:j}=i;return{ups:j?D-1:D+1,isUped:!j}}):a&&S(i=>c(o({},i),{open:!0,status:"error",message:a})))},U=e=>{g(e.currentTarget)},$=()=>{g(null)},W=()=>{$(),A(e=>c(o({},e),{open:!0,url:`${B}#${m}`,post:s}))},E=e=>{$(),h==null||h(e)};l.useEffect(()=>{const{origin:e,pathname:a}=window.location;return R(`${e}${a}`),()=>{k.current=!0}},[]);const r=l.useRef();return l.useEffect(()=>{if(w!==`#${m}`)return;clearTimeout(r.current);const e=n?56:64,a=32;let i=10;return n&&(i+=a/2),r.current=setTimeout(()=>{Te.scrollTo(w,{duration:500,smooth:"easeInOutQuart",offset:-(e+a/2+i)})},0),()=>clearTimeout(r.current)},[w,m]),u("div",{id:`#${m}`,className:O("topic-reply",{hilite:w===`#${m}`,owned:y===d}),children:[u("div",{className:"reply-content",children:[u(b,{className:O("reply-header"),container:!0,wrap:"nowrap",children:[t(Fe,{className:"reply-avatar","aria-label":"Recipe",children:t(q,{to:y?`/user/${y}`:"/",children:F&&t("img",{src:F,alt:y||"\u7528\u6237\u5DF2\u6CE8\u9500"})})}),t(b,{className:"reply-attrs",container:!0,item:!0,zeroMinWidth:!0,wrap:"nowrap",children:u(b,{container:!0,wrap:"nowrap",className:"group",children:[u(b,{className:"uname-text",container:!0,item:!0,zeroMinWidth:!0,wrap:"nowrap",children:[t(b,{item:!0,zeroMinWidth:!0,children:t(q,{className:"uname",to:y?`/user/${y}`:"/",children:y||"\u7528\u6237\u5DF2\u6CE8\u9500"})}),y===d&&t(b,{className:"text",item:!0,children:"[\u4F5C\u8005]"})]}),t(b,{className:"time",item:!0,children:ce(I).fromNow()})]})}),u(b,{className:"reply-actions",item:!0,children:[t(re,{className:"action up",size:"large",onClick:H,children:_.isUped?t(ue,{}):t(me,{})}),Boolean(_.ups)&&t("span",{className:"num",children:_.ups}),t(re,{className:"action more",size:"large",onClick:U,children:t(xe,{})}),t(Re,{open:Boolean(f),anchorEl:f,anchorReference:"anchorEl",anchorPosition:{top:30,left:30},anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},onClose:$,children:u(Ae,{children:[t(oe,{className:"action post",button:!0,onClick:W,children:t(ie,{className:x.icon,children:t(Ue,{})})}),v&&t(oe,{className:"action reply",button:!0,onClick:E,children:t(ie,{className:x.icon,children:t(He,{})})})]})})]})]}),t("div",{className:"markdown-container",children:t(ne,{markdownSource:M})})]}),t(se,c(o({},N),{onClose:()=>{A(e=>c(o({},e),{open:!1}))}})),t(le,c(o({},P),{onClose:()=>{S(e=>c(o({},e),{open:!1}))}}))]})},yt=()=>{var E;const s=Ee(),{topic_id:p}=je(),d=pe("down","sm"),{isAuthed:h,accesstoken:x,uname:w}=ae(r=>r.auth),[n,v]=l.useState({}),[C,z]=l.useState([]),[_,T]=l.useState("loading"),[y,F]=l.useState(null),m=l.useRef(!1),[I,M]=l.useState(""),[f,g]=l.useState({open:!1,action:"reply"}),[B,R]=l.useState({open:!1,url:""}),[k,N]=l.useState({open:!1,status:"success",message:""}),A=async()=>{m.current=!1;const r={tab:f.topicTab,title:f.title,content:f.content},{success:e,err_msg:a}=await De(c(o({},r),{accesstoken:x,topic_id:p}));m.current||(e&&(v(i=>o(o({},i),r)),g(i=>c(o({},i),{open:!1}))),N(i=>c(o({},i),{open:!0,status:e?"success":"error",message:e?"\u66F4\u65B0\u6210\u529F ^_^":a||"\u66F4\u65B0\u5931\u8D25 :("})))},P=async()=>{m.current=!1;const{success:r,data:e,err_msg:a}=await $e({accesstoken:x,content:f.content,topic_id:p,reply_id:I});m.current||(e&&(z(i=>[...i,e]),g(i=>c(o({},i),{open:!1}))),N(i=>c(o({},i),{open:!0,status:r?"success":"error",message:r?"\u56DE\u590D\u6210\u529F ^_^":a||"\u56DE\u590D\u5931\u8D25 :("})))},S=async()=>{f.action==="update"?await A():f.action==="reply"&&await P()},H=()=>{g(r=>c(o({},r),{open:!0,action:"update",title:n.title,content:n.content,topicTab:n.tab}))},U=(r,e)=>{let a=p,i="";e&&(a=e.id,i=`@${e.author.loginname} `),M(a),g(D=>c(o({},D),{open:!0,action:"reply",content:i}))},$=()=>{const{origin:r,pathname:e}=window.location;R(a=>c(o({},a),{open:!0,url:`${r}${e}`}))},W=async()=>{m.current=!1;const r={accesstoken:x,topic_id:p};let e={success:!1,message:""};n.is_collect?(e=await Ne(r),e.message="\u53D6\u6D88\u6536\u85CF"):(e=await Se(r),e.message="\u5DF2\u6536\u85CF"),!m.current&&(e.success&&v(a=>c(o({},a),{is_collect:!a.is_collect})),N(a=>c(o({},a),{open:!0,status:e.success?"success":"error",message:e.success?e.message:e.err_msg||"\u64CD\u4F5C\u5931\u8D25"})))};return l.useEffect(()=>{if(!p)return;m.current=!1;const r=new AbortController;return(async()=>{const{data:e,err_msg:a}=await we({signal:r.signal,accesstoken:x,topic_id:p,mdrender:!1});if(!m.current)if(e){const i=e,{replies:D}=i,j=te(i,["replies"]);T("success"),v(j),z(D)}else a&&(T("error"),F(a))})(),()=>{m.current=!0,r.abort()}},[p,x]),u(Le,{title:n.title,bodyAttributes:{class:O("topic-view",{"error-tips":_==="error","zero-spacings":d})},children:[u("div",{id:"container",children:[t(Oe,{in:Boolean(y),children:t("div",{className:"wrapper tips error",children:y})}),Boolean(n.title)&&u("div",{id:"topic",className:O("wrapper",{dark:s.palette.mode==="dark"}),children:[u("div",{className:"topic-main",children:[t(Ie,{className:"title",variant:"h5",children:n.title}),t("div",{className:"topic-attrs-wrap",children:u("div",{className:"topic-attrs",children:[u("span",{className:"attr-author",children:[t(Be,{className:"avatar",image:n.author.avatar_url,name:n.author.loginname}),t(q,{to:`/user/${n.author.loginname}`,children:n.author.loginname})]}),u("span",{className:"attr-create",children:[t(ge,{}),ce(n.create_at).fromNow()]}),u("span",{className:"attr-visit",children:[t(ve,{}),t("em",{children:n.visit_count}),"\u6D4F\u89C8"]}),n.tab&&u("span",{className:"attr-tab",children:[t(de,{}),t("span",{className:n.tab,children:Me[n.tab].name})]})]})}),t("div",{className:"markdown-container",children:t(ne,{markdownSource:n.content})})]}),Boolean(C.length)&&t("div",{className:"topic-replies",children:C.map((r,e)=>t(ot,{post:e+1,item:r,topicAuthor:n.author.loginname,onReply:a=>{U(a,r)}},r.id))})]}),t("div",{className:"status wrapper",children:t(Pe,{className:"mini",status:_})})]}),h&&u(l.Fragment,{children:[t(_e,{visible:!f.open&&n.author,create:w===((E=n.author)==null?void 0:E.loginname),favorite:Boolean(n.is_collect),notificationOpen:k.open,onUpdate:H,onReply:U,onShare:$,onFavorite:W}),t(ke,c(o({},f),{onChange:r=>{g(e=>o(o({},e),r))},onSubmit:S,onClose:()=>{g(r=>c(o({},r),{open:!1}))}}))]}),t(se,c(o({},B),{onClose:()=>{R(r=>c(o({},r),{open:!1}))}})),t(le,c(o({},k),{onClose:()=>{N(r=>c(o({},r),{open:!1}))}}))]})};export{yt as default};
